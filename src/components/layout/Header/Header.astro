---
import Button from '@/components/ui/Button/Button.astro'
import UiImage from '@/components/ui/Image/Image.astro'
import { getCollection } from 'astro:content'

export interface Props {
  sticky?: 'static' | 'fixed' | 'smart'
}

const { sticky = 'static' } = Astro.props

// Load menu from Content Collection
const menuItems = (await getCollection('menu'))
  .map((item) => item.data)
  .sort((a, b) => a.order - b.order)

const desktopItems = menuItems.filter(
  (item) => item.showOnDesktop && !item.isCTA
)

const mobileItems = menuItems.filter(
  (item) => item.showOnMobile && !item.isCTA
)

const ctaItem = menuItems.find((item) => item.isCTA)
---

<header
  class={['header', `header--sticky-${sticky}`].join(' ')}
  x-data="header()"
  x-init="init()"
  @keydown.escape="close()"
>
  <div class="header__inner container container--lg">
    <!-- Logo -->
    <div class="header__logo">
      <a href="/" aria-label="PÃ¡gina inicial">
        <UiImage
          fallbackSrc="/logo.svg"
          alt="Nome da Empresa"
          width={120}
          height={40}
        />
      </a>
    </div>

    <!-- Desktop Nav -->
    <nav class="header__nav" aria-label="Menu principal">
      <ul class="header__menu">
        {desktopItems.map((item) => {
          const isAnchor = item.href?.startsWith('#')

          return (
            <li>
              <a
                href={item.href}
                class="header__link"
                target={item.target}
                rel={item.rel}
                {...(isAnchor
                  ? { '@click.prevent': `scrollToAnchor('${item.href}')` }
                  : {})}
              >
                {item.label}
              </a>
            </li>
          )
        })}

        <!-- CTA (desktop only) -->
       {ctaItem && (() => {
          const isAnchor = ctaItem.href?.startsWith('#')

          return (
            <li class="header__cta header__cta--desktop">
              <Button
                variant="secondary"
                size="sm"
                href={ctaItem.href}
                target={ctaItem.target}
                {...(isAnchor
                  ? { '@click.prevent': `scrollToAnchor('${ctaItem.href}')` }
                  : {})}
              >
                {ctaItem.label}
              </Button>
            </li>
          )
        })()}
      </ul>
    </nav>

    <!-- Mobile Toggle -->
    <button
      class="header__toggle"
      :class="{ 'is-active': open }"
      @click="toggle()"
      aria-label="Abrir menu"
      :aria-expanded="open.toString()"
    >
      <span></span>
      <span></span>
      <span></span>
    </button>
  </div>

  <!-- Mobile Drawer -->
  <div class="header__mobile" :class="{ 'is-open': open }">
    <nav aria-label="Menu mobile">
      <ul class="header__mobile-menu">
        {mobileItems.map((item) => {
          const isAnchor = item.href?.startsWith('#')

          return (
            <li>
              <a
                class="header__mobile-menu__item"
                href={item.href}
                target={item.target}
                rel={item.rel}
                {...(isAnchor
                  ? { '@click.prevent': `scrollToAnchor('${item.href}')` }
                  : { '@click': 'close()' })}
              >
                {item.label}
              </a>
            </li>
          )
        })}

        <!-- CTA (mobile last) -->
        {ctaItem && (() => {
          const isAnchor = ctaItem.href?.startsWith('#')

          return (
            <li class="header__cta header__cta--mobile">
              <Button
                variant="primary"
                size="sm"
                href={ctaItem.href}
                target={ctaItem.target}
                {...(isAnchor
                  ? { '@click.prevent': `scrollToAnchor('${ctaItem.href}')` }
                  : { '@click': 'close()' })}
              >
                {ctaItem.label}
              </Button>
            </li>
          )
        })()}
      </ul>
    </nav>
  </div>
</header>
